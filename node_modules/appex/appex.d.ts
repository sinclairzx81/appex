/// <reference path="references/typescript.api.d.ts" />
/// <reference path="references/node.d.ts" />

interface ICascade {
    use   ? : {(context:appex.web.IContext) : any;}[];
    verbs ? : string [];
}

declare function cascade (obj:ICascade);
declare function cascade (qualifier:string, obj:ICascade);

declare module appex {
    interface IDisposable {
        dispose(): void;
    }
    interface IDictionary<string, T> {
        [key: string]: T;
    }
}
declare module appex.workers {
    /** a message exchanged between the parent and child process. */
    class Message<T> {
        /** the type of message being sent */
        public type: string;
        /** the message identifier used to associate with waiters */
        public messageid: number;
        /** the body of the message */
        public body: T;
    }
}
declare module appex.workers {
    /** a waiter */
    class Waiter<Response> {
        public messageid: number;
        public delegate: (response: Response) => void;
        /** arguments:
        *       messageid: the message id issued by this waiter.
        *       delegate : the callback handling completed work.
        */ 
        constructor(messageid: number, delegate: (response: Response) => void);
    }
}
declare module appex.workers {
    /** appex worker. a class used differ heavy lifting out to a child_process */
    class Worker<TRequest, TResponse> implements appex.IDisposable {
        public delegate: (request: TRequest, callback: (response: TResponse) => void) => void;
        private child_process;
        private waiters;
        private message_index;
        constructor(delegate: (request: TRequest, callback: (response: TResponse) => void) => void);
        /** dispatches responses to callers.
        *
        *   arguments:
        *       message - the message to dispatch.
        */
        private dispatch(message);
        /** calls the worker.
        *
        *   arguments:
        *       request  - the request to send to the worker.
        *       callback - the callback function containing a response from the worker.
        */
        public call(request: TRequest, callback: (response: TResponse) => void): void;
        /** disposes this worker by terminating its child_process */
        public dispose(): void;
    }
}
declare module appex.compiler {
    /** compilation result */
    interface CompilerResult {
        /** the javascript generated from the compilation */
        javascript: string;
        /** script reflection meta data */
        scripts: typescript.api.Script[];
        /** typescript diagnostic messages (an empty array if no errors occur) */
        diagnostics: typescript.api.Diagnostic[];
    }
}
declare module appex.compiler {
    /** The appex typescript compiler  */
    class Compiler implements appex.IDisposable {
        private worker;
        constructor();
        /** compiles a typescript source file.
        *
        * arguments:
        *       filename - the source file to compile.
        *       callback - a callback for the compilation result.
        */ 
        public compile(filename: string, callback: (result: compiler.CompilerResult) => void): void;
        /** disposes the compiler by terminating the worker process. */
        public dispose(): void;
        /** the compilation kernel. run in a child_process */
        private kernel(filename, callback);
    }
}
declare module appex.modules {
    /** module reflection api */
    class Reflection {
        public scripts: typescript.api.Script[];
        /** arguments:
        *
        *      scripts: the scripts return from a appex compile.
        */
        constructor(scripts: typescript.api.Script[]);
        public get(qualifier: string): typescript.api.ReflectedType;
    }
}
declare module appex.modules {
    /** interface for module exports */
    interface IModuleExport {
        /** the type of export this is */
        type: typescript.api.ReflectedType;
        /** returns a reference to the export */
        accessor(): any;
        /** returns cascading attributes on the export */
        cascade(): any;
    }
    /** interface for modules */
    interface IModule extends appex.IDisposable {
        exports: IModuleExport[];
        /** the vm context. (exported objects accessible on context.exports) */
        context: any;
        /** the javascript this module is mapping */
        javascript: string;
        /** type reflection meta data for this module */
        reflection: modules.Reflection;
        /** compiler diagnostics for this module. */
        diagnostics: typescript.api.Diagnostic[];
        /** compiler diagnostics for this module. */
        cascades: any[];
    }
}
declare module appex.modules {
    class Cascade {
        public name: string;
        public value: any;
    }
    /** A container for javascript objects exported on a module. */
    class ModuleExport implements modules.IModuleExport {
        public module: Module;
        public type: typescript.api.ReflectedType;
        private _accessor;
        private _cascade;
        private _accessor_checked;
        private _cascade_checked;
        /** arguments:
        *       module - the appex module this export is mapping.
        *       type   - the reflected typed information for the object being exported.
        */
        constructor(module: Module, type: typescript.api.ReflectedType);
        /** returns cascading properies on this export. */
        public cascade(): any;
        /** returns a accessor handle to the exported javascript object */
        public accessor(): any;
    }
    /** A vm and object mapping over a javascript module compiled with the appex compiler */
    class Module implements modules.IModule {
        /** exported javascript objects */
        public exports: ModuleExport[];
        /** the vm context. (exported objects accessible on context.exports) */
        public context: any;
        /** the javascript this module is mapping */
        public javascript: string;
        /** type reflection meta data for this module */
        public reflection: modules.Reflection;
        /** compiler diagnostics for this module. */
        public diagnostics: typescript.api.Diagnostic[];
        /** (experimental) attributes defined in this module. */
        public cascades: Cascade[];
        /** arguments
        *       compilerResult - a compilation result from the appex compiler
        */
        constructor(compilerResult: appex.compiler.CompilerResult);
        /** loads the module into a vm */
        private load_vm();
        /** loads the module exports derived from the reflection. */
        private load_exports();
        private load_variable(variable);
        private load_parameter(parameter);
        private load_method(method);
        private load_class(_class);
        private load_interface(_interface);
        private load_import(_import);
        private load_module(_module);
        private load_script(script);
        /** disposes of this module (cleaning up the vm) */
        public dispose(): void;
    }
}
declare module appex.timers {
    /** a stop watch used to time things */
    class StopWatch {
        private starttime;
        constructor();
        /** starts / resets the stopwatch. */
        public start(): void;
        /** stops the stop watch.
        *
        *       returns - the time delta in milliseconds.
        */
        public stop(): number;
    }
}
declare module appex.web.media {
    /** appex mime types */
    class Mime {
        public lookup(filename: string): string;
    }
}
declare module appex.web {
    /** A appex http request */
    interface IRequest extends http.ServerRequest {
    }
    /** patches the nodejs http request with appex request api.
    *
    *   arguments:
    *       request  - the nodejs http request
    *       returns  - nodejs http + appex request api.
    */
    function BindRequest(request: http.ServerRequest): IRequest;
}
declare module appex.web {
    /** A appex http response */
    interface IResponse extends http.ServerResponse {
        headers: appex.IDictionary<string, string>;
        /** sends a response to the http output stream with http status code 200. will set
        *   the 'content-type' http header to 'text/plain' if value has not been set.
        *   arguments:
        *       data - a string value to send.
        */
        send(data: string): void;
        /** sends a response to the http output stream with http status code 200.will set
        *   the 'content-type' http header to 'text/plain' if value has not been set.
        *
        *   arguments:
        *       data - nodejs buffer to send.
        */
        send(data: NodeBuffer): void;
        /** sends a response to the http output stream. will set the 'content-type' http header
        * to 'text/plain' if value has not been set.
        *
        *   arguments:
        *       status - the http status code.
        *       data - nodejs buffer to send.
        */
        send(status: number, data: string): void;
        /** serves a local file with status code 200. if not found, will send status code 404 with a 'not found' message.
        *   will resolve files mime type if the 'content-type' header has not been set.
        *   arguments:
        *       path - the root directory in which to serve.
        *       filepath - the filepath from the root directory to serve.
        */
        serve(path: string, filepath: string): void;
        /** serves a local file with the supplied status code. if not found, will send status code 404 with a 'not found' message.
        *   will resolve files mime type if the 'content-type' header has not been set.
        *
        *   arguments:
        *       status - the http status code.
        *       path - the root directory in which to serve.
        *       filepath - the filepath from the root directory to serve.
        */
        serve(status: number, path: string, filepath: string): void;
        /** sends a json string to the http output stream with http status code 200. will set
        *   the http header 'content-type' to 'application/json' if this value has not been by the
        *   caller.
        *   arguments:
        *       obj - a javascript object.
        */
        json(obj: any): void;
        /** sends a json string to the http output stream with the supplied status code. will set
        *   the http header 'content-type' to 'application/json' if this value has not been by the
        *   caller.
        *
        *   arguments:
        *       status - the http status code.
        *       obj - a javascript object.
        */
        json(status: number, obj: any): void;
        /** sends a jsonp string to the http output stream with http status code 200. will set
        *   the http header 'content-type' to 'text/javascript' if this value has not been by the
        *   caller. the jsonp callback variable name will be set to 'callback'.
        *
        *   arguments:
        *       obj - a javascript object.
        */
        jsonp(obj: any): void;
        /** sends a jsonp string to the http output stream with the supplied status code. will set
        *   the http header 'content-type' to 'text/javascript' if this value has not been by the
        *   caller. the jsonp callback variable name will be set to 'callback'.
        *
        *   arguments:
        *       status - the http status code.
        *       obj - a javascript object.
        */
        jsonp(status: number, obj: any): void;
        /** sends a jsonp string to the http output stream with the supplied status code. will set
        *   the http header 'content-type' to 'text/javascript' if this value has not been by the
        *   caller.
        *
        *   arguments:
        *       status - the http status code.
        *       obj - a javascript object.
        *       callback - a string value to set the jsonp callback variable.
        */
        jsonp(status: number, obj: any, callback: string): void;
    }
    /** patches the nodejs http response with appex response api.
    *
    *   arguments:
    *       response - the nodejs http response
    *       returns  - nodejs http + appex response api.
    */
    function BindResponse(response: http.ServerResponse): IResponse;
}
declare module appex.web {
    interface IContext {
        /** the appex web request */
        request: web.IRequest;
        /** the appex web response */
        response: web.IResponse;
        /** the appex cascade */
        cascade: any;
        /** the next function */
        next: Function;
        /** the appex router */
        router: web.routing.IRouter;
        /** the current executing module */
        module: appex.modules.IModule;
    }
}
declare module appex.web.routing {
    /** appex route interface */
    interface IRoute {
        /** matches a route from the given request
        *
        *   arguments:
        *       context  - the context.
        */
        match(context: web.IContext): boolean;
        /** handles route invocation.
        *
        *   arguments:
        *       context  - the context.
        *       request  - the nodejs http request.
        *       response - the nodejs http response.
        *       returns  - success if the route was handled.
        */
        handler(context: web.IContext): boolean;
    }
}
declare module appex.web.routing {
    /** appex router interface */
    interface IRouter {
        /** the routes */
        routes: routing.IRoute[];
        /** router http handler
        *
        *   arguments:
        *       context  - the app context
        *       request  - the nodejs http request.
        *       response - the nodejs http response.
        */
        handler(context: web.IContext): boolean;
    }
}
declare module appex.web {
    /** appex server start options **/
    interface IServerOptions {
        program: string;
        devmode?: boolean;
        logging?: boolean;
        protocol?: string;
        context?: any;
        stdout?: WritableStream;
        stderr?: WritableStream;
    }
    /** normalizes the appex server start options
    *
    *   arguments:
    *       options - the options to normalize.
    *       returns - the normalized options.
    */
    function NormalizeServerOptions(options: IServerOptions): IServerOptions;
}
declare module appex.web {
    /** interface for appex servers. */
    interface IServer extends appex.IDisposable {
        options?: web.IServerOptions;
        /** creates a nodejs http server on the given port.
        *
        *  arguments:
        *      port : the port to listen on.
        */
        listen(port: number): void;
        /** the http request handler.
        *
        *   arguments:
        *       request  - the nodejs http request.
        *       response - the nodejs http response.
        *       next     - (optional) the next callback used for express / connect middleware.
        */
        handler(request: http.ServerRequest, response: http.ServerResponse, next?: Function): void;
    }
}
declare module appex.web.routing {
    /** appex generic route. handles named routes / function */
    class IndexRoute implements routing.IRoute {
        public moduleExport: appex.modules.IModuleExport;
        /** the pathname used to match this route. */
        public pathname: string;
        /** arguments:
        *       moduleExport : the module export for this route. (must be a function).
        */
        constructor(moduleExport: appex.modules.IModuleExport);
        /** matches a route from the given request
        *
        *   arguments:
        *       request : the nodejs http request to match.
        */
        public match(context: web.IContext): boolean;
        /** invokes the target.
        *
        *   arguments:
        *       method  : the method to invoke.
        *       context : the context.
        */
        private invoke(method, context);
        /** handles route invocation.
        *
        *   arguments:
        *       app      - the application context.
        *       request  - the nodejs http request.
        *       response - the nodejs http response.
        *       returns  - success if the route was handled.
        */
        public handler(context: web.IContext): boolean;
        /** initializes this route */
        private initialize();
    }
}
declare module appex.web.routing {
    /** appex named route. handles named routes / function */
    class NamedRoute implements routing.IRoute {
        public moduleExport: appex.modules.IModuleExport;
        /** the pathname used to match this route. */
        public pathname: string;
        /** arguments:
        *       moduleExport : the module export for this route. (must be a function).
        */
        constructor(moduleExport: appex.modules.IModuleExport);
        /** matches a route from the given request
        *
        *   arguments:
        *       request : the nodejs http request to match.
        */
        public match(context: web.IContext): boolean;
        /** invokes the target.
        *
        *   arguments:
        *       method  : the method to invoke.
        *       context : the context.
        */
        private invoke(method, context);
        /** handles route invocation.
        *
        *   arguments:
        *       app      - the application context.
        *       request  - the nodejs http request.
        *       response - the nodejs http response.
        *       returns  - success if the route was handled.
        */
        public handler(context: web.IContext): boolean;
        /** initializes this route */
        private initialize();
    }
}
declare module appex.web.routing {
    /** appex wildcard route. handles wildcard routing and url parameters */
    class WildcardRoute implements routing.IRoute {
        public moduleExport: appex.modules.IModuleExport;
        /** regular expressions used in matching routes */
        public regexps: RegExp[];
        /** arguments:
        *       moduleExport : the module export for this route. (must be a function).
        */
        constructor(moduleExport: appex.modules.IModuleExport);
        /** matches a route from the given request
        *
        *   arguments:
        *       request : the nodejs http request to match.
        */ 
        public match(context: web.IContext): boolean;
        /** invokes the target.
        *
        *   arguments:
        *       method  : the method to invoke.
        *       context : the context.
        */
        private invoke(method, parameters, context);
        /** handles route invocation.
        *
        *   arguments:
        *       context  - the context.
        *       request  - the nodejs http request.
        *       response - the nodejs http response.
        *       returns  - success if the route was handled.
        */
        public handler(context: web.IContext): boolean;
        /** initializes this route */
        private initialize();
        /** loads arguments from the url.
        *
        *   arguments:
        *       url : the url pathname
        *       returns: an array of arguments to applied to the invocation target.
        */
        private arguments(url);
    }
}
declare module appex.web.routing {
    /** the appex router */
    class ModuleRouter implements routing.IRouter {
        public module: appex.modules.IModule;
        /** the routes */
        public routes: routing.IRoute[];
        /** the appex module in which to apply routes
        *
        *   arguments:
        *       module - the appex module.
        */
        constructor(module: appex.modules.IModule);
        /** router http handler
        *
        *   arguments:
        *       app      - the app context
        *       request  - the nodejs http request.
        *       response - the nodejs http response.
        */
        public handler(context: web.IContext): boolean;
        /** initializes the router */
        private initialize();
        /** resolves a route from a appex modules export
        *
        *   arguments:
        *       moduleExport - the module export to resolve.
        *       returns      - a route (or null if not applicable)
        */
        private resolve_route_from_export(moduleExport);
        /** validates a wildcard signature */
        private validate_wildcard_signature(method);
        /** validates a index signature */
        private validate_index_signature(method);
        /** validates a named signature */
        private validate_named_signature(method);
    }
}
declare module appex.web {
    class Context implements web.IContext {
        /** the appex request */
        public request: web.IRequest;
        /** the appex response */
        public response: web.IResponse;
        /** the appex cascade */
        public cascade: any;
        /** the next function */
        public next: Function;
        /** the appex router */
        public router: web.routing.IRouter;
        /** the current executing module */
        public module: appex.modules.IModule;
    }
}
declare module appex.web {
    /** a appex development server. manages JIT compilations on http request. */
    class DevelopmentServer implements web.IServer {
        public options: web.IServerOptions;
        private server;
        private compiler;
        private module;
        private router;
        private waiters;
        private compiling;
        /** arguments:
        *    options - server start options.
        */
        constructor(options: web.IServerOptions);
        /** creates a nodejs http server based on the server options protocol.
        *
        *  arguments:
        *      port - the port to listen on.
        */
        public listen(port: number): void;
        /** the http request handler.
        *
        *   arguments:
        *       request  - the nodejs http request.
        *       response - the nodejs http response.
        *       next     - (optional) the next callback used for express / connect middleware.
        */ 
        public handler(request: http.ServerRequest, response: http.ServerResponse, next?: Function): void;
        /** loads the context.
        *
        *   arguments:
        *       request  - the nodejs http request
        *       response - the nodejs http response
        *       next     - the next function
        *       returns  - the context
        */ 
        private load_context(request, response, next?);
        /** compiles options.program and loads the module and router.
        *
        *   arguments:
        *       callback - a callback containing any diagnostics.
        */ 
        private compile(callback);
        /** emits compilation errors to options.stdout and http buffer.
        *
        *   arguments:
        *       diagnostics - the diagnostics to emit.
        */
        private errors(diagnostics);
        /** disposes of this server */
        public dispose(): void;
    }
}
declare module appex.web {
    /** a appex server. JIT once and watch it fly. */
    class Server implements web.IServer {
        public options: web.IServerOptions;
        private server;
        private compiler;
        private module;
        private router;
        private waiters;
        private compiled;
        private compiling;
        /** arguments:
        *    options - server start options.
        */
        constructor(options: web.IServerOptions);
        /** creates a nodejs http server based on the server options protocol.
        *
        *  arguments:
        *      port - the port to listen on.
        */
        public listen(port: number): void;
        /** the http request handler.
        *
        *   arguments:
        *       request  - the nodejs http request.
        *       response - the nodejs http response.
        *       next     - (optional) the next callback used for express / connect middleware.
        */ 
        public handler(request: http.ServerRequest, response: http.ServerResponse, next?: Function): void;
        /** loads the context.
        *
        *   arguments:
        *       request  - the nodejs http request
        *       response - the nodejs http response
        *       next     - the next function
        *       returns  - the context
        */ 
        private load_context(request, response, next?);
        /** compiles options.program once and loads the module and router.
        *
        *   arguments:
        *       callback - a callback containing any diagnostics.
        */ 
        private compile(callback);
        /** emits compilation errors to options.stdout and a 500 'internal server error' message to http buffer.
        *
        *   arguments:
        *       diagnostics - the diagnostics to emit.
        */
        private errors(diagnostics);
        /** disposes of this server */
        public dispose(): void;
    }
}
